# ==========================================================================
# garden.zap.cooking â€” nginx reverse proxy for Pyramid relay
# ==========================================================================

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name garden.zap.cooking;
    return 301 https://$host$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name garden.zap.cooking;

    # --- TLS (managed by certbot) ---
    ssl_certificate /etc/letsencrypt/live/garden.zap.cooking/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/garden.zap.cooking/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- Gzip Compression ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/nostr+json
        image/svg+xml
        font/woff2;

    # --- Static files served directly by nginx ---
    location = /garden-theme.css {
        alias /var/www/garden/garden-theme.css;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        add_header X-Content-Type-Options nosniff;
    }

    location = /garden-profiles.js {
        alias /var/www/garden/garden-profiles.js;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        add_header X-Content-Type-Options nosniff;
    }

    location = /garden-login.js {
        alias /var/www/garden/garden-login.js;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        add_header X-Content-Type-Options nosniff;
    }

    location = /garden-invite.js {
        alias /var/www/garden/garden-invite.js;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        add_header X-Content-Type-Options nosniff;
    }

    location /fonts/ {
        alias /var/www/garden/fonts/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        add_header Access-Control-Allow-Origin *;
    }

    # --- Reverse Proxy to Pyramid ---
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;

        # WebSocket support (essential for Nostr relay)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable Accept-Encoding so sub_filter can process uncompressed HTML
        proxy_set_header Accept-Encoding "";

        # Long timeouts for WebSocket connections (Nostr relay keeps alive)
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Inject custom CSS and profile-enhancement JS into HTML pages
        sub_filter '</head>' '<link rel="stylesheet" href="/garden-theme.css"/><script defer src="/garden-profiles.js"></script><script defer src="/garden-login.js"></script><script defer src="/garden-invite.js"></script></head>';
        sub_filter_once on;
        sub_filter_types text/html;
    }
}

# WebSocket connection upgrade map (place in http block or include)
# NOTE: Add this to /etc/nginx/nginx.conf inside the http { } block:
#
#   map $http_upgrade $connection_upgrade {
#       default upgrade;
#       ''      close;
#   }
